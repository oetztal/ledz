<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timers - ledz</title>
    <link rel="stylesheet" href="/common.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Timers & Schedules</h1>
            <p>Configure countdown timers and daily alarms</p>
        </div>
        <div class="nav">
            <a href="/">&larr; Back to Control Panel</a>
        </div>
        <div class="content">
            <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Current Time (UTC<span id="tzDisplay"></span>)</div>
                        <div id="serverTime" style="font-size: 32px; font-weight: 600; font-family: monospace; letter-spacing: 2px;">--:--:--</div>
                    </div>
                    <div style="text-align: right;">
                        <select id="timezoneOffset" style="padding: 8px 12px; border-radius: 6px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 14px;">
                            <option value="-12">UTC-12</option>
                            <option value="-11">UTC-11</option>
                            <option value="-10">UTC-10</option>
                            <option value="-9">UTC-9</option>
                            <option value="-8">UTC-8</option>
                            <option value="-7">UTC-7</option>
                            <option value="-6">UTC-6</option>
                            <option value="-5">UTC-5</option>
                            <option value="-4">UTC-4</option>
                            <option value="-3">UTC-3</option>
                            <option value="-2">UTC-2</option>
                            <option value="-1">UTC-1</option>
                            <option value="0" selected>UTC+0</option>
                            <option value="1">UTC+1</option>
                            <option value="2">UTC+2</option>
                            <option value="3">UTC+3</option>
                            <option value="4">UTC+4</option>
                            <option value="5">UTC+5</option>
                            <option value="6">UTC+6</option>
                            <option value="7">UTC+7</option>
                            <option value="8">UTC+8</option>
                            <option value="9">UTC+9</option>
                            <option value="10">UTC+10</option>
                            <option value="11">UTC+11</option>
                            <option value="12">UTC+12</option>
                        </select>
                        <button onclick="setTimezone()" style="margin-left: 8px; padding: 8px 16px; border-radius: 6px; border: none; background: rgba(255,255,255,0.3); color: white; cursor: pointer; font-size: 14px;">Save</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Active Timers</h2>
                <div id="timerList">
                    <p style="color: #666;">Loading...</p>
                </div>
            </div>

            <div class="section">
                <h2>Quick Off Timer</h2>
                <p>Turn off LEDs after a set duration.</p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="setQuickTimer(15*60)" style="min-width: 80px;">15 min</button>
                    <button class="btn btn-primary" onclick="setQuickTimer(30*60)" style="min-width: 80px;">30 min</button>
                    <button class="btn btn-primary" onclick="setQuickTimer(60*60)" style="min-width: 80px;">1 hour</button>
                    <button class="btn btn-primary" onclick="setQuickTimer(120*60)" style="min-width: 80px;">2 hours</button>
                </div>
            </div>

            <div class="section">
                <h2>Custom Countdown Timer</h2>
                <p>Set a custom countdown timer with a specific duration and action.</p>

                <div class="form-group">
                    <label for="countdownMinutes">Duration (minutes)</label>
                    <input type="number" id="countdownMinutes" min="1" max="10080" value="30" placeholder="Enter minutes">
                </div>

                <div class="form-group">
                    <label for="countdownAction">Action</label>
                    <select id="countdownAction">
                        <option value="off">Turn Off LEDs</option>
                        <option value="preset">Load Preset</option>
                    </select>
                </div>

                <div class="form-group" id="countdownPresetGroup" style="display: none;">
                    <label for="countdownPreset">Preset to Load</label>
                    <select id="countdownPreset">
                        <option value="">Select preset...</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="setCustomCountdown()">Set Countdown Timer</button>
            </div>

            <div class="section">
                <h2>Daily Alarm</h2>
                <p>Set a recurring daily alarm to trigger an action at a specific time each day.</p>

                <div class="form-group">
                    <label for="dailyAlarmTime">Alarm Time</label>
                    <input type="time" id="dailyAlarmTime" value="07:00">
                </div>

                <div class="form-group">
                    <label for="dailyAlarmAction">Action</label>
                    <select id="dailyAlarmAction">
                        <option value="off">Turn Off LEDs</option>
                        <option value="preset">Load Preset</option>
                    </select>
                </div>

                <div class="form-group" id="dailyAlarmPresetGroup" style="display: none;">
                    <label for="dailyAlarmPreset">Preset to Load</label>
                    <select id="dailyAlarmPreset">
                        <option value="">Select preset...</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="setDailyAlarm()">Set Daily Alarm</button>

                <div class="info-box">
                    <strong>Note:</strong> Daily alarms trigger every day at the specified time. Use the timezone setting below to ensure accurate timing.
                </div>
            </div>

            <div class="section">
                <h2>Timezone</h2>
                <p>Set your timezone offset from UTC for accurate alarm timing.</p>

                <div class="form-group">
                    <label for="timezoneOffset">Timezone Offset (hours from UTC)</label>
                    <select id="timezoneOffset">
                        <option value="-12">UTC-12</option>
                        <option value="-11">UTC-11</option>
                        <option value="-10">UTC-10 (Hawaii)</option>
                        <option value="-9">UTC-9 (Alaska)</option>
                        <option value="-8">UTC-8 (Pacific)</option>
                        <option value="-7">UTC-7 (Mountain)</option>
                        <option value="-6">UTC-6 (Central)</option>
                        <option value="-5">UTC-5 (Eastern)</option>
                        <option value="-4">UTC-4 (Atlantic)</option>
                        <option value="-3">UTC-3</option>
                        <option value="-2">UTC-2</option>
                        <option value="-1">UTC-1</option>
                        <option value="0" selected>UTC+0</option>
                        <option value="1">UTC+1 (CET)</option>
                        <option value="2">UTC+2 (EET)</option>
                        <option value="3">UTC+3 (Moscow)</option>
                        <option value="4">UTC+4</option>
                        <option value="5">UTC+5</option>
                        <option value="5.5">UTC+5:30 (India)</option>
                        <option value="6">UTC+6</option>
                        <option value="7">UTC+7</option>
                        <option value="8">UTC+8 (China)</option>
                        <option value="9">UTC+9 (Japan)</option>
                        <option value="10">UTC+10 (Sydney)</option>
                        <option value="11">UTC+11</option>
                        <option value="12">UTC+12 (NZ)</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="setTimezone()">Update Timezone</button>

                <div class="info-box">
                    <strong>Current Server Time:</strong> <span id="serverTime">Loading...</span> (UTC<span id="tzDisplay"></span>)
                </div>
            </div>
        </div>
    </div>

    <script>
        let presets = [];
        let timersData = [];
        let timersFetchedAt = 0;
        let serverTimeAtFetch = 0;
        let timezoneOffsetHours = 0;

        // Format seconds as human-readable time
        function formatTime(seconds) {
            if (seconds <= 0) return '0s';
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
            }
        }

        // Format seconds since midnight as HH:MM
        function formatTimeOfDay(secondsSinceMidnight) {
            const hours = Math.floor(secondsSinceMidnight / 3600);
            const mins = Math.floor((secondsSinceMidnight % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // Load presets for dropdowns
        async function loadPresets() {
            try {
                const response = await fetch('/api/presets');
                const data = await response.json();
                presets = data.presets || [];

                const options = presets.map(p =>
                    `<option value="${p.index}">${p.name}</option>`
                ).join('');

                document.getElementById('countdownPreset').innerHTML =
                    '<option value="">Select preset...</option>' + options;
                document.getElementById('dailyAlarmPreset').innerHTML =
                    '<option value="">Select preset...</option>' + options;
            } catch (error) {
                console.error('Failed to load presets:', error);
            }
        }

        // Fetch timers from backend
        async function fetchTimers() {
            try {
                const response = await fetch('/api/timers');
                const data = await response.json();
                timersData = (data.timers || []).filter(t => t.enabled);
                timersFetchedAt = Date.now();

                // Update timezone dropdown
                timezoneOffsetHours = data.timezone_offset_hours || 0;
                document.getElementById('timezoneOffset').value = timezoneOffsetHours;
                document.getElementById('tzDisplay').textContent = (timezoneOffsetHours >= 0 ? '+' : '') + timezoneOffsetHours;

                // Update server time display
                if (data.local_seconds_since_midnight !== undefined && data.current_epoch !== 0) {
                    serverTimeAtFetch = data.local_seconds_since_midnight;
                } else {
                    serverTimeAtFetch = -1; // NTP not available
                }

                updateTimerDisplay();
            } catch (error) {
                console.error('Failed to load timers:', error);
                document.getElementById('timerList').innerHTML =
                    '<p style="color: #d9534f;">Failed to load timers</p>';
            }
        }

        // Update timer display using cached data
        function updateTimerDisplay() {
            const timerList = document.getElementById('timerList');
            const elapsedSeconds = Math.floor((Date.now() - timersFetchedAt) / 1000);

            // Update server time display
            const serverTimeElement = document.getElementById('serverTime');
            if (serverTimeAtFetch >= 0) {
                const currentLocalSeconds = (serverTimeAtFetch + elapsedSeconds) % 86400;
                serverTimeElement.textContent = formatTimeOfDay(currentLocalSeconds);
                serverTimeElement.style.color = '';
            } else {
                serverTimeElement.textContent = 'NTP not available';
                serverTimeElement.style.color = '#d9534f';
            }

            // Filter out expired timers
            const activeTimers = timersData.filter(t => {
                if (t.type_name === 'alarm_daily') return true;
                return t.remaining_seconds - elapsedSeconds > 0;
            });

            if (activeTimers.length === 0) {
                timerList.innerHTML = '<p style="color: #666;">No active timers</p>';
                if (timersData.length > 0) {
                    // A timer expired, refresh from backend
                    timersData = [];
                    fetchTimers();
                }
            } else {
                timerList.innerHTML = activeTimers.map(timer => {
                    let description = '';
                    let timeInfo = '';
                    let typeLabel = '';

                    // Get preset name if action is LOAD_PRESET
                    let actionText = 'Turn off';
                    if (timer.action === 0) {
                        const preset = presets.find(p => p.index === timer.preset_index);
                        actionText = preset ? `Load "${preset.name}"` : `Load preset #${timer.preset_index}`;
                    }

                    // Describe the timer type
                    switch (timer.type_name) {
                        case 'countdown':
                            typeLabel = 'Countdown';
                            timeInfo = formatTime(Math.max(0, timer.remaining_seconds - elapsedSeconds));
                            description = `${actionText} in ${timeInfo}`;
                            break;
                        case 'alarm_once':
                            typeLabel = 'One-time';
                            timeInfo = formatTime(Math.max(0, timer.remaining_seconds - elapsedSeconds));
                            description = `${actionText} in ${timeInfo}`;
                            break;
                        case 'alarm_daily':
                            typeLabel = 'Daily';
                            const alarmTime = formatTimeOfDay(timer.target_time);
                            description = `${actionText} at ${alarmTime}`;
                            break;
                    }

                    return `
                        <div class="info-box" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>${typeLabel}:</strong> ${description}
                            </div>
                            <button class="btn btn-danger" onclick="cancelTimer(${timer.index})" style="padding: 6px 12px; font-size: 13px;">Cancel</button>
                        </div>
                    `;
                }).join('');
            }
        }

        // Set a quick off timer
        async function setQuickTimer(seconds) {
            try {
                const response = await fetch('/api/timers/countdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        duration: seconds,
                        action: 1 // TURN_OFF
                    })
                });

                const result = await response.json();
                if (result.success) {
                    await fetchTimers();
                } else {
                    alert('Failed to set timer: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to set timer:', error);
                alert('Failed to set timer');
            }
        }

        // Set a custom countdown timer
        async function setCustomCountdown() {
            const minutes = parseInt(document.getElementById('countdownMinutes').value);
            const actionSelect = document.getElementById('countdownAction').value;

            if (!minutes || minutes < 1) {
                alert('Please enter a valid duration');
                return;
            }

            const requestBody = {
                duration: minutes * 60
            };

            if (actionSelect === 'preset') {
                const presetIndex = parseInt(document.getElementById('countdownPreset').value);
                if (isNaN(presetIndex)) {
                    alert('Please select a preset');
                    return;
                }
                requestBody.action = 0; // LOAD_PRESET
                requestBody.preset_index = presetIndex;
            } else {
                requestBody.action = 1; // TURN_OFF
            }

            try {
                const response = await fetch('/api/timers/countdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                if (result.success) {
                    await fetchTimers();
                    alert('Countdown timer set!');
                } else {
                    alert('Failed to set timer: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to set timer:', error);
                alert('Failed to set timer');
            }
        }

        // Set a daily alarm
        async function setDailyAlarm() {
            const timeValue = document.getElementById('dailyAlarmTime').value;
            const actionSelect = document.getElementById('dailyAlarmAction').value;

            if (!timeValue) {
                alert('Please enter a time');
                return;
            }

            const [hours, mins] = timeValue.split(':').map(Number);

            const requestBody = {
                daily: true,
                hour: hours,
                minute: mins
            };

            if (actionSelect === 'preset') {
                const presetIndex = parseInt(document.getElementById('dailyAlarmPreset').value);
                if (isNaN(presetIndex)) {
                    alert('Please select a preset');
                    return;
                }
                requestBody.action = 0; // LOAD_PRESET
                requestBody.preset_index = presetIndex;
            } else {
                requestBody.action = 1; // TURN_OFF
            }

            try {
                const response = await fetch('/api/timers/alarm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                if (result.success) {
                    await fetchTimers();
                    alert('Daily alarm set!');
                } else {
                    alert('Failed to set alarm: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to set alarm:', error);
                alert('Failed to set alarm');
            }
        }

        // Cancel a timer
        async function cancelTimer(index) {
            if (!confirm('Cancel this timer?')) {
                return;
            }

            try {
                const response = await fetch('/api/timers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index })
                });

                const result = await response.json();
                if (result.success) {
                    await fetchTimers();
                } else {
                    alert('Failed to cancel timer: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to cancel timer:', error);
                alert('Failed to cancel timer');
            }
        }

        // Set timezone
        async function setTimezone() {
            const offset = parseInt(document.getElementById('timezoneOffset').value);

            try {
                const response = await fetch('/api/timers/timezone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ offset })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Timezone updated!');
                    await fetchTimers();
                } else {
                    alert('Failed to set timezone: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to set timezone:', error);
                alert('Failed to set timezone');
            }
        }

        // Show/hide preset select based on action selection
        document.getElementById('countdownAction').addEventListener('change', (e) => {
            document.getElementById('countdownPresetGroup').style.display =
                e.target.value === 'preset' ? 'block' : 'none';
        });

        document.getElementById('dailyAlarmAction').addEventListener('change', (e) => {
            document.getElementById('dailyAlarmPresetGroup').style.display =
                e.target.value === 'preset' ? 'block' : 'none';
        });

        // Initialize
        loadPresets();
        fetchTimers();

        // Update display every second (uses cached data)
        setInterval(updateTimerDisplay, 1000);
    </script>
</body>
</html>
